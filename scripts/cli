#!/usr/bin/env node

const fs = require('fs-extra')
const path = require('path')
const { exec } = require('child_process')

const installDirectory = path.join(process.cwd(), 'govuk-prototype-kit')
const kitRoot = path.join(__dirname, '..')
const kitDependency = 'https://github.com/alphagov/govuk-prototype-kit.git#2022-08_user-testing'

const copyFile = (fileName) => fs.copy(path.join(kitRoot, fileName), path.join(installDirectory, fileName))
const command = process.argv[2]

;(async () => {
  if (command === 'install') {
    if (fs.pathExistsSync(installDirectory)) {
      console.error('Cannot create as something exists in:')
      console.error(installDirectory)
      process.exit(3)
    }
    fs.ensureDir(installDirectory)
    await Promise.all([
      fs.copy(path.join(kitRoot, 'prototype-starter'), installDirectory),
      copyFile('CHANGELOG.md'),
      copyFile('LICENCE.txt'),
      copyFile('.npmrc'),
      copyFile('.nvmrc')
    ])
    const installProcess = exec(`npm install ${kitDependency} govuk-frontend`, {
      inherit: true,
      cwd: installDirectory
    })
    installProcess.stdout.on('data', function (data) {
      console.log(data)
    })
  } else if (command === 'start') {
    require('../start')
  } else {
    console.log(`I don't know how to handle ${command}`)
    process.exit(2)
  }
})()
